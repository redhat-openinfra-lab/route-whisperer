# Route Whisperer

## Introduction

This project serves as a workaround for VRF route leaking issues affecting scope local routes with FRR/CUDN/OpenShift. A mutating admission webhook is used to track CREATE/UPDATEs for ClusterUserDefinedNetworks (CUDN) at cluster scope. When a CUDN is created, the webhook server will create a ConfigMap specific to that CUDN with metadata indicating if routes should be published. A DaemonSet is then used to reconcile static routes in the hosts vrf based on the ConfigMaps generated by the webhook server.

## Deploying the Webhook Server

To deploy the webhook server, run the following:

```command
oc apply -k manifests/webhook-server/base
```

To validate, check the deployment (two pods should be running):

```
$ oc get deployment -nroute-whisperer route-whisperer-webhook-server
NAME                             READY   UP-TO-DATE   AVAILABLE   AGE
route-whisperer-webhook-server   2/2     2            2           56m
```

## Deploying the DaemonSet

The DaemonSet can be deployed by running the command:

```command
oc apply -k manifests/daemonset/base
```

To validate, check the DaemonSet:

```command
$ oc get daemonset -nroute-whisperer-daemonset route-reconciler
NAME               DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
route-reconciler   3         3         3       3            3           <none>          55m
```

## Configuring DaemonSet

The DaemonSet configuration is controlled by a ConfigMap. The default values are:

```command
$ oc get configmap -nroute-whisperer-daemonset reconciler-config -oyaml | yq -P .data
bgp_vrf: bgp
configmap_label_selector: route-whisperer.openinfra.io
sleep_duration: "10"
webhook_server_namespace: route-whisperer
```

|Variable|Type|Required|Description|
|:---|:---|:---|:---|
|`bgp_vrf`|String|True|VRF on the hosts that is used to leak routes to network.|
|`configmap_label_selector`|String|True|Label selector use to find ConfigMaps generated by the webhook server.|
|`sleep_duration`|String|True|String representing the number of seconds the route reconciler should sleep before iterating again.|
|`webhook_server_namespace`|String|True|Namespace of webhook server.|

> [!NOTE]
> Only `bgp_vrf` and `sleep_duration` values should be modified.

## Deploying the Mutating Admission Webhook

This serves as the final step and will 'activate' the webhook:

```command
oc create -f manifests/mutatingwebhookconfiguration.yaml
```
